\chapter[Software]{Software}

\section[WebService]{WebService}

\subsection{Requisitos do Projeto}

\subsubsection{Cadastrar usuário}

\textbf{Dado} que a API receba uma requisição para cadastrar um novo usuário

\textbf{E} todos os campos do usuário sejam válidos

\textbf{Então} o usuário deve ser cadastrado.

\subsubsection{Autenticar usuário}

\textbf{Dado} que a API receba uma requisição para autenticar um usuário

\textbf{E} todos os campos do usuário sejam válidos

\textbf{Então} o token correspondente ao usuário deve ser gerado.

\subsubsection{Realizar Pagamento}

\textbf{Dado} que a API receba uma requisição para registrar um pagamento

\textbf{E} os dados de pagamento sejam validados junto a API do PagSeguro

\textbf{Então} a transação deve ser efetivada.

\subsubsection{Gerar Qrcode}

\textbf{Dado} que a API receba uma notificação da API do PagSeguro

\textbf{E} o status da transação seja alterado para \textit{paga}

\textbf{Então} deve ser gerado um QrCode.

\subsubsection{Validar qrcode}

\textbf{Dado} que a API receba uma requisição com um QrCode

\textbf{E} o QrCode seja válido

\textbf{Então} deve ser retornado as informações referente ao QrCode.

\subsubsection{Mostrar chopps}

\textbf{Dado} que a API receba uma requisição para mostrar os chopps de um usuário

\textbf{E} o usuário esteja logado

\textbf{Então} deve ser retornado os chopps referentes a esse usuário.

\subsubsection{Salvar dados dos sensores}

\textbf{Dado} que a API receba uma requisição para salvar os dados dos sensores

\textbf{E} os dados sejam válidos

\textbf{Então} os dados devem ser salvos.

\subsubsection{Mostrar dados dos sensores}

\textbf{Dado} que a API receba uma requisição para mostrar os dados dos sensores

\textbf{E} o usuário seja um administrador

\textbf{Então} os dados devem ser mostrados.

\subsection{Projeto}

A demanda do problema exige que diferentes hardwares se integrem com uma
mesma base de dados. Fundamentalmente, o Smartphone do usuário realiza a compra, e
a máquina deve validar o QrCode para que o usuário consuma o chopp.

Para solucionar essa demanda foi proposto uma arquitetura orientada a serviços
(SOA), tal que uma webservice REST seja responsável pela persistência e autenticação de todos os
dados relevantes do sistema. Sendo assim esse WebService será responsável por se comunicar com
todos os outros subsistemas.

O modelo de domínio abaixo traz uma visão inicial das entidades presentes no sistema.

\begin{figure}[H]
    \centering
    \includegraphics[scale= 0.5]{figuras/modelo-dominio.png}
    \caption{Modelo de Domínio. Fonte: Própria.}
    \label{modelagem}
\end{figure}

\subsection{Solução Adotada}

Visto que é requisito primordial do sistema o checkout de pagamentos via cartão de cŕedito, a
tecnologia escolhida para implementação desse WebService foi o framework 
Ruby On Rails\footnote{\url{http://rubyonrails.org/}}, pois a API de pagamentos do PagSeguro
fornece suporte a essa tecnologia. A versão utilizada do Ruby foi a versão 2.3.0 e o Rails a versão 5.0.5.

\subsubsection[Arquitetura]{Arquitetura}

\subsubsubsection{Models}

As classes modelos no Rails representam as entidades e seus relacionamentos, e são responsáveis pelo gerenciamento dos dados
no banco. O diagrama de classes abaixo representa as classes modelos do sistema:

\begin{figure}[H]
    \centering
    \includegraphics[scale= 0.5]{figuras/diagrama-models.png}
    \caption{Diagrama de Classes - Models. Fonte: Própria.}
    \label{modelagem}
\end{figure}

\begin{itemize}
    \item \textbf{User:} A classe \textit{User} guarda as informações referentes a um usuário.
    \item \textbf{Order:} A classe \textit{Order} guarda as informações referentes a um pedido
     de um usuário específico. 
    \item \textbf{Chopp:} A classe \textit{Chopp} guarda as informações referentes a um chopp
    de um pedido específico.
    \item \textbf{SensorStorage:} A classe \textit{SensorStorage} guarda as informações referentes
    aos valores lidos dos sensores do módulo embarcado.
    \item \textbf{AuthenticateUser:} A classe \textit{AuthenticateUser} é responsável por autenticar um usuário
    na base de dados.
    \item \textbf{AuthorizeApiRequest:} A classe \textit{AuthorizeApiRequest} é reponsável por 
    decodificar determinado token de autenticação.
\end{itemize}

\subsubsubsection{Controllers}

As classes controladoras no Rails são responsáveis por se comunicar com as classes modelos, e são elas que lidam com
requisições web do usuário. O diagrama de classes abaixo representa as classes controladoras do sistema:

\begin{figure}[H]
    \centering
    \includegraphics[scale= 0.5]{figuras/diagrama-controllers.png}
    \caption{Diagrama de Classes - Controllers. Fonte: Própria.}
    \label{modelagem}
\end{figure}

\begin{itemize}
    \item \textbf{ApplicationController:} A classe \textit{ApplicationController} é a controladora padrão do Rails
    e todas as outras controladoras são herdadas a partir desta.
    \item \textbf{UsersController:} A classe \textit{UsersController} é responsável por enviar e receber os dados dos usuários.
    \item \textbf{AuthenticationController:} A classe \textit{AuthenticationController} é reponsável por receber os dados do usuário
    e realizar a autenticação.
    \item \textbf{ChoppsController:} A classe \textit{ChoppsController} é responsável por enviar e receber os dados dos chopps.
    \item \textbf{SensorsController:} A classe \textit{SensorsController} é responsável por enviar e receber os dados dos sensores.
    \item \textbf{CheckoutController:} A classe \textit{CheckoutController} é responsável por receber os dados de pagamento e enviar
    a API do PagSeguro.
    \item \textbf{NotificationController:} A classe \textit{NotificationController} é reponsável por receber notificações da API
    do PagSeguro quando uma transação muda de status.
    \item \textbf{PagSeguro:} Entidade que representa a API do PagSeguro.
\end{itemize}

\subsubsection{Gerência e Configuração}

Escrever sobre deploy e integração contínua

% Para hospedagem do WebService foi usado o Heroku\footnote{\url{https://www.heroku.com/}}.
% As vantagens em utilizar essa plataforma estão no custo, 
% por ser uma ferramenta grátis e na facilidade de fazer o deploy.

\subsection{Casos de Teste}

Escrever como foi testada a API

\section[Aplicativo Mobile]{Aplicativo Mobile}

Para compra e gerenciamento dos cupons de \textit{chopp}, torna-se necessário um aplicativo \textit{mobile} de forma que seja facilitado a acessibilidade para os usuários.

\subsection{Requisitos do Projeto}

\subsubsection{Comprar Chopp}

\textbf{Dado} que o usuário esteja logado

\textbf{Quando} tenha iniciado a compra de um chopp

\textbf{Então} deve ser possível ver as preferências de chope(colarinho, quantidades discretas e pré-definidas)

\subsubsection{Cadastrar Usuário}

\textbf{Dado} que o usuário tente entrar no sistema 

\textbf{E} ainda não tenha se cadastrado

\textbf{Quando} tenha iniciado o aplicativo

\textbf{Então} terá disponível um formulário com email e senha para cadastro

\subsubsection{Confirmar Cadastro}

\textbf{Dada} que o usuário já tenha se cadastrado

\textbf{E} recebido um email com link de confirmação

\textbf{Quando} clicar no link

\textbf{Então} deverá ser levado a uma mensagem de confirmação

\textbf{E} deve ser possível se autenticar no sistema.

\subsubsection{Finalizar Compra}

\textbf{Dado} que o usuário já esteja cadastrado no sistema

\textbf{E} tenha clicado para comprar um chopp

\textbf{E} tenha acesso a internet

\textbf{Quando} finalizado a compra

\textbf{Então} deve ser possível inserir os dados do cartão de crédito

\textbf{E} ser notificado se a compra foi bem sucedida ou não

\textbf{E} em seus tickets devem estar disponíveis para uso na máquina

\subsubsection{Listar Cupons(QRCode)}

\textbf{Dado} que o usuário já tenha comprado tickets

\textbf{E} esteja autenticado no sistema

\textbf{Quando} clicar em uma opção meus tickets

\textbf{Então} deve ser possível  visualizar o QRCode que representa a unidade de chopp

\textbf{E} deverá ter disponível uma opção para usar o ticket

\textbf{E} caso já tenha sido usado o ticket, deverá sumir da lista de tickets do usuário

\subsubsection{Efetuar Compra Offline}

\textbf{Dada} a compra efetuada de um chopp

\textbf{E} um usuário offline

\textbf{Quando} o usuário clicar para usar o ticket

\textbf{Então} a máquina de chopp deve responder no sistema de interação com mensagem sucesso.

\subsubsection{Visualizar Cupon(QRCode)}

\textbf{Dado} que o usuário tenha comprado tickets

\textbf{Quando} entrar na tela de visualização de tickets

\textbf{Então} deve ser possível ver os tickets comprados segundo as preferências

\textbf{E} poder escolher qual queira consumir

\subsection{Projeto}

De acordo com os critérios observados do público alvo e do contexto considerado, pensou-se em um aplicativo mobile que se comunica com um Web Service para realizar as operações descritas na especificação acima.

\subsection{Solução Adotada}

Por fim, foi desenvolvido um aplicativo multiplataforma utilizando o \textit{framework Ionic 3}, baseado em \textit{Angular 4}. As imagens das telas do aplicativo estão na \ref{telasapp1} e \ref{telasapp2}.

\begin{figure}[H]
\centering
\includegraphics[scale= 0.4]{figuras/homepage.png}
\includegraphics[scale= 0.4]{figuras/signup.png}   
\includegraphics[scale= 0.4]{figuras/home-loged.png}
\caption{Página Inicial - Registrar - Página Inicial com usuário logado. Fonte: Própria.}
\label{telasapp1}
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[scale= 0.5]{figuras/pedidos.png}        
\includegraphics[scale= 0.5]{figuras/MeusChopps.png}
\caption{Tela de Compra - Tela de Pedidos. Fonte: Própria.}
\label{telasapp2}
\end{figure}

\subsection{Casos de Teste}

Achar os casos de teste especificados no PC1...


\section[Sistema Administrativo]{Sistema Administrativo}

O Sistema administrativo está incorporado ao aplicativo do Sistema de Compras, porém apenas usuários
administradores possuem acesso. Ao utilizar o aplicativo, o usuário visualiza
as seguintes informações referentes ao estado da máquina: a quantidade de chopp que a
máquina possui, a temperatura de resfriamento e o status da conexão da máquina com a internet.

Esses valores são recuperados através de requisições GET ao WebService que guarda essas informações recebendo
requisições POST a cada 60 seg da aplicação que lê os dados dos sensores. 

\section[Sistema de Validação de Compra]{Sistema de Validação de Compra}

O sistema de validação se trata do módulo responsável pela validação dos dados da compra,
e dar o inicio no processo de serventia de chopp conforme as característias são pré-definidas.
Esse subsistema tinha como resultados esperados uma aplicação que pudesse prover ao usuário
a leitura do \textit{QRCode} gerado no momento da compra do chopp por meio de uma câmera 
acoplada na máquina de onde o chopp é armazenado. No \textit{QRCode} estão contidas as informações
referentes as preferências do consumidor no que tange sua bebida.

Devido à necessidade de que o usuário tenha acesso a uma câmera para leitura do \textit{QRCode},
foi escolhido o \textit{framework} Python Kivy\footnote{\url{https://kivy.org/}} por fornecer um ambiente
\textit{touchscreen} com um baixo consumo de recursos, uma vez que essa aplicação estará 
instanciada em uma Raspberry responsável por gerenciar outros módulos operacionais do projeto.

Desta forma, foi então desenvolvida aplicação Autochopp-Machine \footnote{\url{https://github.com/autochopp/autochopp-machine}} que fornece de forma interativa 
com a validação de \textit{QRCodes} e iniciação do processo de retirada do chopp. 

Além do que foi citado, a aplicação também possui a responsabilidade de fazer requisições junto a API
para que a mesma possa informar se o \textit{QRCode} lido é válido, significando que a compra foi 
efetuada com sucesso, caso não śeja válido, é exibida uma mensagem de erro. A partir da combinação
de preferências feitas no momento da compra, é gerado um identificador que é vinculado ao 
\textit{QRCode}. Esse identificador é o responsável por passar as informações via socket para que
os componentes eletrônicos vinculados a máquina sejam capazes de atuar na composição do chopp conforme
suas especificações.

\begin{figure}[H]
    \centering
    \includegraphics[scale= 0.4]{figuras/home-screen.png}
    \caption{Tela Inicial. Fonte: Própria.}
    \label{home-screen}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[scale= 0.4]{figuras/leitor-qrcode.png}
    \caption{Tela de Leitura de \textit{QRCode}. Fonte: Própria.}
    \label{leitor-qrcode}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[scale= 0.4]{figuras/sucesso.png}
    \caption{Tela informando que o \textit{QRCode} foi lido com sucesso. Fonte: Própria.}
    \label{sucesso}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[scale= 0.4]{figuras/falha.png}
    \caption{Tela informando que o \textit{QRCode} não foi lido com sucesso. Fonte: Própria.}
    \label{falha}
\end{figure}


